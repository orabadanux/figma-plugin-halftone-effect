<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Halftone Effect Plugin UI</title>
    <!-- Tailwind CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-white">
    <div id="root" class="max-w-xl mx-auto p-4 min-h-screen flex flex-col items-center justify-center">

      <!-- Placeholder container, centered text -->
      <div id="placeholder-container" class="w-full flex items-center justify-center">
        <div id="placeholder" class="text-gray-600 text-lg">Select an image</div>
      </div>
    </div>

    <script>
      let originalImage = null;
      let canvas, ctx;
      let sliderGrid, selectShape, colorPicker, btnGenerate;
      const shapes = ["Circle", "Square", "Cross"];

      function setupUI() {
        const root = document.getElementById("root");

        // HIDE placeholder instead of removing it
        const placeholderContainer = document.getElementById("placeholder-container");
        if (placeholderContainer) placeholderContainer.style.display = "none";

        // Append canvas
        canvas = document.createElement("canvas");
        canvas.id = "previewCanvas";
        canvas.className = "border border-gray-300 mb-4 w-full";
        root.appendChild(canvas);
        ctx = canvas.getContext("2d");

        // Controls container
        const controls = document.createElement("div");
        controls.id = "controls";
        controls.className = "space-y-4 w-full";

        // Dot Size slider
        const gridContainer = document.createElement("div");
        gridContainer.className = "slider-container";
        const labelGrid = document.createElement("label");
        labelGrid.className = "block font-medium";
        labelGrid.innerText = "Dot Size";
        sliderGrid = document.createElement("input");
        sliderGrid.id = "gridSlider";
        sliderGrid.type = "range";
        sliderGrid.min = "1";
        sliderGrid.max = "50";
        sliderGrid.value = "10";
        sliderGrid.className = "w-full";
        gridContainer.appendChild(labelGrid);
        gridContainer.appendChild(sliderGrid);
        controls.appendChild(gridContainer);

        // Combined row for Dot Shape and Dot Color
        const combinedRow = document.createElement("div");
        combinedRow.className = "flex flex-row items-center space-x-4";

        // Dot Shape dropdown
        const shapeContainer = document.createElement("div");
        shapeContainer.className = "flex-1";
        const labelShape = document.createElement("label");
        labelShape.className = "block font-medium";
        labelShape.innerText = "Dot Shape";
        selectShape = document.createElement("select");
        selectShape.id = "shapeSelect";
        selectShape.className = "w-full p-2 border border-gray-300 rounded";
        shapes.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.innerText = s;
          selectShape.appendChild(opt);
        });
        shapeContainer.appendChild(labelShape);
        shapeContainer.appendChild(selectShape);
        combinedRow.appendChild(shapeContainer);

        // Dot Color picker
        const colorContainer = document.createElement("div");
        colorContainer.className = "flex-1";
        const labelColor = document.createElement("label");
        labelColor.className = "block font-medium";
        labelColor.innerText = "Dot Color";
        colorPicker = document.createElement("input");
        colorPicker.id = "colorPicker";
        colorPicker.type = "color";
        colorPicker.value = "#000000";
        colorPicker.className = "w-full h-12 p-0 border-none rounded";
        colorContainer.appendChild(labelColor);
        colorContainer.appendChild(colorPicker);
        combinedRow.appendChild(colorContainer);

        controls.appendChild(combinedRow);

        // Generate button
        btnGenerate = document.createElement("button");
        btnGenerate.id = "generateBtn";
        btnGenerate.innerText = "Generate";
        btnGenerate.className = "bg-blue-500 text-white py-2 px-4 rounded w-full";
        controls.appendChild(btnGenerate);

        root.appendChild(controls);

        // Event listeners
        [sliderGrid, selectShape, colorPicker].forEach((control) => {
          control.addEventListener("input", updateCanvas);
        });

        btnGenerate.addEventListener("click", () => {
          const dataURL = canvas.toDataURL("image/png").split(",")[1];
          parent.postMessage({ pluginMessage: { type: "apply-effect", imageData: dataURL } }, "*");
        });
      }

      function updateCanvas() {
        if (!originalImage || !canvas || !ctx) return;
        canvas.width = originalImage.width;
        canvas.height = originalImage.height;

        ctx.drawImage(originalImage, 0, 0);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const gridSize = Number(sliderGrid.value);
        const maxRadius = gridSize / 2;
        const shape = selectShape.value;
        const dotColor = colorPicker.value;

        for (let y = 0; y < canvas.height; y += gridSize) {
          for (let x = 0; x < canvas.width; x += gridSize) {
            let totalLum = 0;
            let validCount = 0;
            for (let j = 0; j < gridSize; j++) {
              for (let i = 0; i < gridSize; i++) {
                const px = x + i;
                const py = y + j;
                if (px < canvas.width && py < canvas.height) {
                  const idx = (py * canvas.width + px) * 4;
                  const r = imgData.data[idx];
                  const g = imgData.data[idx + 1];
                  const b = imgData.data[idx + 2];
                  const a = imgData.data[idx + 3];
                  if (a >= 128) {
                    const lum = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                    totalLum += lum;
                    validCount++;
                  }
                }
              }
            }
            if (validCount === 0) continue;
            const avgLum = totalLum / validCount;
            const radius = maxRadius * (1 - avgLum / 255);
            if (radius < 0.5) continue;

            ctx.fillStyle = dotColor;
            const centerX = x + gridSize / 2;
            const centerY = y + gridSize / 2;
            if (shape === "Circle") {
              ctx.beginPath();
              ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
              ctx.fill();
            } else if (shape === "Square") {
              const side = radius * 2;
              ctx.fillRect(centerX - radius, centerY - radius, side, side);
            } else if (shape === "Cross") {
              const barWidth = radius / 2;
              ctx.fillRect(centerX - radius, centerY - barWidth / 2, radius * 2, barWidth);
              ctx.fillRect(centerX - barWidth / 2, centerY - radius, barWidth, radius * 2);
            }
          }
        }
      }

      // Listen for messages from code.ts
      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        console.log("UI received message:", msg);
        if (msg.type === "load-image") {
          const imageDataURL = "data:image/png;base64," + msg.data;
          const img = new Image();
          img.onload = () => {
            originalImage = img;
            setupUI();
            updateCanvas();
          };
          img.src = imageDataURL;
        } else if (msg.type === "no-image") {
          document.getElementById("placeholder-container").style.display = "flex";
        }
      };

      console.log("UI script loaded");
    </script>
  </body>
</html>
